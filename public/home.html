<html>
<head>
    <link rel="stylesheet" type="text/css" href="home.css">

</head>
<body>
    <div class="month">      
        <ul>
          <li class="prev"><img src="agenda-icon.png" alt="" width="100" height="100"></li>


            <li class="next"><img src="cron.png" alt="" width="100" height="100"></li>
          <li><p id="user_name"> <p>
            <span style="font-size:50px" onclick="irParaOMesAnterior()">&#10096;  </span>
              <span style="font-size:45px" id="mes"></span>
              <span style="font-size:50px" onclick="irParaOProximoMes()">  &#10097;</span>
              <p><a class="prev" href="adicionarevento.html">Adicionar Evento</a></p><br>
            <span style="font-size:18px">2020</span>
          </li>
        </ul>
      </div>

    <div id ="dias">

    </div>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-firestore.js"></script>
    <script src="script_meses.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBMasMxL8BhY9OSyNkAmMZqfMtSlaYDEp8",
            authDomain: "weebdario.firebaseapp.com",
            databaseURL: "https://weebdario.firebaseio.com",
            projectId: "weebdario",
            storageBucket: "weebdario.appspot.com",
            messagingSenderId: "742261135078",
            appId: "1:742261135078:web:67e5be9399087e69efcd27"
        };


        var user = {};

        var mes = new Date().getMonth();
        var diaDaSemanaQueOMesComeca = new Date(2020, mes,1).getDay();
        var diasNosMeses = [31,28,31,30,31, 30,31,31,30,31,30,31];
        var meses = ['Janeiro',
            'Fevereiro',
            'Março',
            'Abril',
            'Maio',
            'Junho',
            'Julho',
            'Agosto',
            'Setembro',
            'Outubro',
            'Novembro',
            'Dezembro'];
        function getUser() {
            return JSON.parse(localStorage.getItem('user'));
        }


        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        var listaEventos = [];
      window.onload = function() {
        init();
      };

      function init() {
        user = getUser();
        recuperarEventos();
        document.getElementById('user_name').innerHTML = 'Olá, ' +user.nome+' esse é o seu mes de ';
        document.getElementById('mes').innerHTML = meses[mes].toUpperCase();
      }
      function preencheDias() {
          var temEventoEsseMes = false;
          var diasDeEvento = {};
          for(let i = 0; i < listaEventos.length; i++){
              evento = listaEventos[i];
              if (evento.mes.toString() === mes.toString()){
                  temEventoEsseMes = true;
                  diasDeEvento[evento.dia] = i;
              }
          }

        var diasNaSemana = 7;
        var semanasNoMes = 5;
        var diasNoMes = diasNosMeses[mes];
        var templateTabela = `<table style="width:100%">
        <tr>
          <th class="weekdays">Dom</th>
          <th class="weekdays">Seg</th>
          <th class="weekdays">Ter</th>
          <th class="weekdays">Qua</th>
          <th class="weekdays">Qui</th>
          <th class="weekdays">Sex</th>
          <th class="weekdays">Sab</th>
        </tr>`;
        var dia = 1;
        for(let j = 0; j < semanasNoMes; j++) {
          templateTabela+= `<tr class="days" >`
            for(let i = 0; i < diasNaSemana; i++){
              if(j === 0 && i<diaDaSemanaQueOMesComeca ){
                templateTabela+= `<td></td>`
              }
              else {
                  if(dia<=diasNoMes){
                      var adicionar = true;
                      for(let [diaDoEvento, posicaoNoVetor] of Object.entries(diasDeEvento)){
                          if(diaDoEvento == dia){
                              templateTabela += `<td>` + dia + `<br><span style="font-size:12px">` +listaEventos[posicaoNoVetor].titulo +  `</span></td>`;
                              adicionar = false
                          }
                      }
                      if(adicionar)
                          templateTabela += `<td>` + dia + `</td>`;

                      dia++;
                  }  else {
                  templateTabela+= `<td></td>`
                }
              }
            }


          templateTabela+= `</tr>`
        }
        document.getElementById('dias').innerHTML = templateTabela + `</table>`
      }

      function irParaOProximoMes(){
        mes++;
          diaDaSemanaQueOMesComeca = new Date(2020, mes,1).getDay();
        init();
      }
      function irParaOMesAnterior() {
          if(mes>9){
              mes--;
              diaDaSemanaQueOMesComeca = new Date(2020, mes,1).getDay();
              init();
          }
      }

        function recuperarEventos(){
            if(user.eventos[0]){
                db.collection("eventos").where('id', 'in', user.eventos)
                    .get()
                    .then(function(querySnapshot) {
                        querySnapshot.forEach(function(doc) {
                                // doc.data() is never undefined for query doc snapshots
                                listaEventos.push(doc.data())
                            }
                        );
                        preencheDias();
                    })
                    .catch(function(error) {
                        console.log("Error getting documents: ", error);
                    });
            }else{
                preencheDias();
            }
        }

    </script>
</body>
</html>
